# 系统加固与审查清单

本文档记录对「智能报告生成系统」的全面审查与加固项，便于后续维护与协作者拉取后少出问题。

---

## 一、已加固项（本次 Review）

### 1. 仪表盘 `app/dashboard/page.tsx`

- **变量引用**：已修复历史遗留的未定义变量 `featuredOnly`，统一使用 `featuredReports`。
- **API 返回**：对 `/api/reports` 的 `response.json()` 做防护，使用 `Array.isArray(data?.reports) ? data.reports : []`，避免 `data.reports` 缺失或非数组时抛错。
- **排序**：`sortFn` 中对 `title`、`updatedAt`、`createdAt` 做空值/默认值处理，避免 `undefined` 导致排序报错。
- **渲染**：报告卡片与列表中对 `report.id`、`report.title`、`report.updatedAt`、`report.status`、`report.progress` 等使用 `??` 或可选链，避免异常数据导致白屏。

### 2. 报告生成流式页 `app/report/new/page.tsx`

- **SSE 解析**：对每条 `data:` 的 `JSON.parse` 结果做类型与存在性检查（`data == null`、`typeof data.reportId`、`Array.isArray(data.chapters)` 等），再写入 state，避免畸形数据导致前端抛错。

### 3. 智能问答页 `app/chat/[reportId]/page.tsx`

- **reportId**：在加载报告上下文、加载会话列表的 `useEffect` 中增加 `if (!reportId || typeof reportId !== "string") return`，避免 `reportId` 缺失时请求异常路径或 localStorage key 异常。
- **reportContext**：所有使用 `reportContext.title`、`reportContext.chapters` 的地方改为 `reportContext?.title`、`reportContext?.chapters ?? []`，并保证 `chapters` 的 `filter`/`map` 在空数组上安全执行。
- **localStorage**：会话列表初始化时对 `localStorage.getItem` 做 try/catch，避免无痕模式等环境下读存储抛错。

### 4. 报告详情页 `app/report/[reportId]/page.tsx`

- **元数据接口**：对 `/api/report-meta/:id` 的 `response.json()` 做 `metadata` 空值判断，并给 `setReportConfig` 各字段提供 `?? []` / `?? ""` / `?? 0` 等默认值。
- **PATCH 与文件列表**：对更新元数据与上传文件接口的返回做 `updated?.dataFiles`、`payload?.files` 的数组校验，再 `setDataFiles`，避免非数组导致后续 `.map` 等报错。

### 5. 认证与设置 `lib/auth-context.tsx`、`app/settings/page.tsx`

- **AuthProvider**：  
  - 初始 state 中读取 `localStorage` 与 `JSON.parse` 整体包在 try/catch 内，任何异常均回退为 `null`。  
  - `saveUsers`、登录/注册中写入 `localStorage`、以及 `logout` 中 `removeItem` 均包在 try/catch，避免无痕/配额等问题导致抛错。
- **Settings**：  
  - 从 `localStorage` 读取并 `JSON.parse` 的初始化逻辑包在 try/catch，解析失败或缺失时使用 `defaultSettings`。  
  - `handleSave` / `handleReset` 中的 `localStorage.setItem` / `removeItem` 包在 try/catch，避免写入失败影响 UI 状态。

### 6. API：报告列表 `app/api/reports/route.ts`

- **单文件异常隔离**：每个报告文件的处理（`stat`、读 meta、读 md 首行等）包在独立 try/catch 内，单文件损坏或缺失只跳过该条并打日志，仍返回其余报告列表。
- **缺失/异常字段**：返回对象中 `title`、`createdAt`、`updatedAt`、`summary`、`fileSize` 等使用 `??` 或存在性检查，避免 undefined 导致序列化或前端解析异常。

### 7. 错误边界与错误页 `components/error-boundary.tsx`

- **重新加载**：使用 `window.location.reload()` 做整页刷新，避免仅重置 state 导致同一错误再次触发。
- **错误详情**：错误信息与组件堆栈写入 `sessionStorage`，并在页面上展示、提供「复制错误信息」按钮，便于排查。
- **端口提示**：错误页上提示「浏览器地址与终端 Local 一致（如 3000/3001）」，减少端口不一致导致的误判。

---

## 二、建议规范（避免再次出现类似问题）

1. **前端请求 API 后解析 body**  
   - 始终假定 `response.json()` 可能返回 `null` 或与预期结构不符。  
   - 对「列表」使用 `Array.isArray(x) ? x : []`，对「对象」使用 `x ?? {}` 或逐字段 `??` 默认值后再用。

2. **路由参数**  
   - 对 `useParams()` 得到的 `reportId` 等，在使用前做 `if (!id || typeof id !== "string") return` 或重定向，避免请求 `/api/.../undefined` 或异常 key。

3. **localStorage / sessionStorage**  
   - 读：包在 try/catch 中，失败时使用默认值或空结构。  
   - 写：在无痕或配额满时可能抛错，建议包在 try/catch 并酌情提示或静默降级。

4. **变量命名与重构**  
   - 重命名或删除变量时全局搜索引用（如之前的 `featuredOnly`），避免遗漏导致 `ReferenceError`。

5. **协作者拉取后**  
   - 必须进入子目录 `report-generation-system` 再执行 `pnpm install` 与 `pnpm dev`。  
   - 复制 `.env.example` 为 `.env.local` 并至少配置 `OPENROUTER_API_KEY`。  
   - 不要为「能打开」而改业务逻辑；端口冲突时使用 `pnpm run dev:3001` 并访问对应端口。

---

## 三、与「适配性说明」的关系

- **`docs/适配性说明.md`**：侧重「为什么拉取后可能打不开、哪些代码不能乱改、推荐步骤」。  
- **本文档**：侧重「已在代码里做过的加固项与推荐编码规范」，便于后续改动的自检与 Code Review。

两者配合使用，可降低环境差异与误改导致的反复出问题。
