# 当前具备与缺失清单

> 对照「从 n8n 迁移到本系统」的实现计划，列出已具备与尚未具备的项。便于你确认是否还需要提供其它资料。

---

## 一、已具备（可以直接用或已实现）

| 类别 | 项 | 说明 |
|------|----|------|
| **文档** | 流程与需求 | `docs/新报告流程梳理.md`：用户输入、6 块数据、大模型逻辑、占位符 |
| **文档** | 报告提示词模板 | `docs/报告提示词模板.md`：System Prompt、User Prompt 全文及 10 个占位符 |
| **文档** | 实现计划 | `docs/实现计划-从n8n迁移到本系统.md`：前端/后端/阶段一～三 |
| **文档** | 搜索查询生成提示词 | `docs/n8n参考-搜索查询生成提示词.md`：Google 查询、YouTube 查询的 n8n 提示词（阶段二自动发现网站/视频时用） |
| **代码** | 产品详情 RapidAPI | `lib/server/data-sources.ts`：`fetchAmazonDataFromRapidAPI`，product-details，已有 |
| **代码** | 评论 RapidAPI | `lib/server/data-sources.ts`：`fetchProductReviewsFromRapidAPI`、`fetchCombinedReviewsFromRapidAPI`，product-reviews，asin/page/country，已实现 |
| **代码** | 网页抓取 ScrapingBee | `lib/server/data-sources.ts`：`fetchWebWithScrapingBee`、`fetchMultipleWebWithScrapingBee`，已有 |
| **代码** | 报告存储与元数据 | `lib/server/report-storage.ts`、generate 里写 report_<id>.md 和 metadata，已有 |
| **代码** | 报告详情页展示 | 读取 Markdown 并渲染，已有 |
| **代码** | OpenRouter 调用方式 | generate 里已有 fetch 到 OpenRouter chat/completions，鉴权、Referer 等已有 |
| **环境** | API Key 配置方式 | `.env.local`：OPENROUTER_API_KEY、RAPIDAPI_KEY、RAPIDAPI_AMAZON_HOST、SCRAPINGBEE_API_KEY，你已配置或已知 |

**结论**：流程理解、提示词模板、数据源能力（产品+评论+网页）、存储与展示、OpenRouter 调用，这些都已经具备。缺的是「把现有能力按新流程串起来」和「前端上传/报告语言」。

---

## 二、还不具备（需要实现或需要你提供）

### 2.1 必须实现才能跑通「阶段一」的

| 序号 | 项 | 说明 |
|------|----|------|
| 1 | **前端：FormData 提交 + 文件上传** | 当前提交是 JSON，退货报告/人群画像未传到后端。需改为 FormData：`payload`（JSON 字符串）+ 可选 `returnsFile`、`audienceFile`。 |
| 2 | **前端：报告语言字段** | 提示词里要「报告语言」展示名（如「英文」）。需前端增加选择并传 `reportLanguage`。 |
| 3 | **后端：FormData 解析** | generate 当前 `request.json()`。需改为 `request.formData()`，取 `payload`、`returnsFile`、`audienceFile`。 |
| 4 | **后端：上传文件解析为文本** | 退货报告、人群画像：支持 CSV/TXT（Excel 可后加），解析成纯文本；无文件则传 `NO_RETURN_REPORT` / `NO_PERSONA_REPORT`。 |
| 5 | **后端：评论注入报告流程** | 在 generate 里调用 `fetchCombinedReviewsFromRapidAPI(allAsins, marketplace, { maxPerAsin: 100 })`，得到的内容作为 `COMBINED_REVIEWS` 注入提示词。当前 generate 未调用评论接口。 |
| 6 | **后端：按模板单次生成报告** | 当前是 7 章、7 次 LLM 调用、旧提示词。需改为：组装 6 块数据 → 替换 `报告提示词模板.md` 的 10 个占位符 → **一次** OpenRouter 调用 → 整份报告写入 report_<id>.md。 |
| 7 | **数据来源展示与持久化** | 需确保「抓到了什么」可展示（链接、条数、字符数），且抓取内容存库供问答使用 | 见 `docs/数据来源展示与持久化方案.md`：建表 `report_sources`，生成时每抓一块写库；新增 API `GET /api/reports/:reportId/sources`；报告详情页「数据源」Tab 展示；问答接口从库中读取抓取资料参与检索。 |

以上 7 项做完，即可「提交 → 拉数据并入库 → 生成报告 → 详情页展示报告 + 数据来源」；问答可基于报告 + 抓取资料。

### 2.2 阶段二（自动发现网站/视频）还缺的

| 序号 | 项 | 说明 |
|------|----|------|
| 7 | **执行 Google 搜索的 API** | 用「Google 搜索查询生成」提示词得到 queries 后，需要真正执行搜索拿到 URL。n8n 里若用了 SerpApi、Google Custom Search 等，需要你提供：用哪个服务、Key 或配置方式。 |
| 8 | **YouTube 视频链接来源** | 用「YouTube 搜索查询」得到 queries 后，需要执行搜索得到视频 URL。同上，需确认你用的搜索 API。 |
| 9 | **YouTube 字幕来源** | 拿到视频 URL 后，字幕是 ScrapingBee 抓 transcript 页、还是 YouTube Data API、还是其它？需你确认或提供接口/截图。 |

---

## 三、总结

- **已具备**：文档与流程、报告提示词模板、产品/评论/网页的数据源代码、报告存储与展示、OpenRouter、环境变量方式。  
- **还不具备**：  
  - **阶段一**：前端 FormData+文件+报告语言；后端 FormData 解析、文件解析、评论接入、按模板单次生成报告（共 6 项实现）。  
  - **阶段二**：执行 Google/YouTube 搜索的 API、YouTube 字幕的获取方式（需你提供或确认 3 项）。

如果你愿意，下一步可以从「阶段一」这 6 项开始实现，实现完就可以用你手头数据在系统里跑出一篇和 n8n 逻辑一致的报告。
