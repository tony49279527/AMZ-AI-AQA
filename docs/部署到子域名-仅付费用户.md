# 部署到 amzaiagent.com 子域名（仅付费用户）

目标：把系统上线到例如 **report.amzaiagent.com**，不对外公开，只给已付费用户使用，提高稳定性、数据不依赖本机。

**主站 amzaiagent.com 已在 Google Cloud Run**，建议报告系统也部署在同一 GCP 项目下，用子域名指向新服务（见下方「方式 C」）。

---

## 主站域名在 Cloudflare 时怎么做（简要）

你当前：**amzaiagent.com** 在 **Cloudflare** 托管 DNS，主站对应 Cloud Run 服务 **amz-ai-replica**（us-central1）。要加子域名 **report.amzaiagent.com** 给报告系统用，按下面做即可，**不用动主站**。

1. **在 GCP 再部署一个 Cloud Run 服务**（第三个服务），例如名字叫 **report-system**，区域用 **us-central1**（和主站一致即可）。部署方式见下方「方式 C」。
2. **在 GCP 做域名映射**：左侧 **Cloud Run → Domain mappings** →「添加映射」→ 选服务 **report-system**，域名选 **amzaiagent.com**（若已验证过主站域名，这里会直接有），子域名填 **report**，得到 **report.amzaiagent.com**。保存后 GCP 会显示「需要在 DNS 里添加的记录」（一般是 CNAME：`report` → 某个 `*.run.app` 或 Google 提供的目标）。
3. **在 Cloudflare 里加一条 DNS**：  
   - 类型：**CNAME**（按 GCP 显示为准）。  
   - 名称：**report**（即 report.amzaiagent.com）。  
   - 目标：**照抄 GCP 域名映射页给出的值**（例如 `ghs.googlehosted.com` 或 Cloud Run 提供的 URL）。  
   - 代理状态：建议先选 **仅 DNS（灰云）**，等 HTTPS 能访问后再考虑是否开「代理（橙云）」。
4. 等 DNS 生效（几分钟到几十分钟），用浏览器访问 **https://report.amzaiagent.com** 即可。主站 **amzaiagent.com** 继续指 **amz-ai-replica**，不用改。

---

## 一、子域名与访问控制

- **子域名示例**：`report.amzaiagent.com` 或 `app.amzaiagent.com`（任选一个，在 DNS / Cloud Run 域名映射里指到报告服务即可）。
- **不让普通用户看到**：
  - 主站 amzaiagent.com 上**不要放这个子域名的入口**，只在付费用户交付时发链接。
  - 可选：在项目里开启「访问码」，只有知道访问码的人能打开系统（见下文「访问码」）。

---

## 二、部署方式（三选一）

### 方式 C：Google Cloud Run（与主站一致，推荐）

和主站一样用 Cloud Run，同一 GCP 项目下再部署一个**新服务**，把 **report.amzaiagent.com** 指到这个服务即可。

**1. 在项目根目录（report-generation-system）执行：**

若仓库是共享的、你的代码在 **dev** 分支（而不是 main），部署前先切到 dev，再部署，这样部署出去的就是 dev 的代码：

```bash
# 确保在 dev 分支（你的改动都在这里）
git fetch origin
git checkout dev
git pull origin dev

# 已安装 gcloud 并登录、选好项目
gcloud config set project 你的项目ID

# 从当前目录（dev 分支）构建并部署
gcloud run deploy report-system \
  --source=. \
  --region=us-central1 \
  --platform=managed \
  --allow-unauthenticated
```

若你本地本来就是 dev、且已拉过最新，直接执行 `gcloud run deploy ...` 即可；**--source=. 会按当前目录当前分支的代码来构建**。

若你用 Docker 镜像（例如 CI 构建好再推 Artifact Registry），可改为：

```bash
gcloud run deploy report-system \
  --image=你的区域-docker.pkg.dev/项目ID/仓库名/report-system:latest \
  --region=... \
  --allow-unauthenticated
```

**2. 绑定子域名 report.amzaiagent.com：**

- 在 Cloud Run 控制台：选中 **report-system** 服务 →「管理与流量」/「域名」→「添加映射」→ 选择/验证 **amzaiagent.com**，子域名填 **report**。
- 或若主站通过「负载均衡 + 域名」管理：在同一个负载均衡里为 **report.amzaiagent.com** 新增一条规则，后端选 **report-system** 服务。

**3. 环境变量：**

在 Cloud Run 控制台该服务的「修订版本」→「变量与密钥」里，把下面「环境变量」一节里的项全部配好（含 `API_ACCESS_TOKEN`、`NEXT_PUBLIC_APP_URL=https://report.amzaiagent.com`、OpenRouter 等）。敏感信息可用「密钥」引用。

**4. 报告持久化（重要）：**

Cloud Run 实例本身无持久盘，**不挂载的话报告在重新部署/扩缩容后会丢**。建议用 **Cloud Storage 挂载** 到容器里的报告目录：

- 在 GCP 建一个桶，例如 `你的项目ID-report-data`。
- 更新 Cloud Run 服务，挂载该桶到容器内 **/app/content/reports**（本项目用 Dockerfile 时的工作目录为 /app，报告路径即 /app/content/reports）：

```bash
gcloud run services update report-system \
  --region=你的region \
  --execution-environment=gen2 \
  --add-volume=name=reports-vol,type=cloud-storage,bucket=你的项目ID-report-data \
  --add-volume-mount=volume=reports-vol,mount-path=/app/content/reports
```

（若你用的服务名/区域不同，把 `report-system` 和 `--region` 换成自己的。若未用本项目 Dockerfile 而是用 `--source` 由 buildpacks 构建，请先确认容器内工作目录，再把桶挂载到 **工作目录/content/reports**。）

这样报告会落在 GCS 桶里，**重新部署、多实例之间都共用同一份报告**。

---

### 方式 A：Vercel（最简单，但报告文件不持久）

- 适合：先快速上线、接受**报告数据不持久**（每次部署或重建可能清空）。
- 步骤概要：
  1. 把代码推到 GitHub（你的提交在 **dev** 分支即可），用 [Vercel](https://vercel.com) 导入该仓库；根目录选 **report-generation-system**（若仓库根就是该项目则不用改）；在 Vercel 项目设置里把 **Production Branch** 改成 **dev**，这样部署用的是 dev 分支。
  2. 在 Vercel 里添加域名：**report.amzaiagent.com**，按提示在 DNS 添加 CNAME 指向 Vercel 给的地址。
  3. 在 Vercel 的「Environment Variables」里配置下面「环境变量」一节的所有项（注意生产环境勾选 Production）。
  4. 部署后访问 `https://report.amzaiagent.com`。
- 限制：Vercel 是无状态环境，**content/reports 里的报告在重建后会丢**。若需要报告长期保留，请用方式 C 或 B。

### 方式 B：自己的服务器（VPS / 云主机）

- 适合：**报告和上传文件要长期保留**、且不想用 Cloud Run 时。
- 步骤概要：
  1. 买一台 Linux 服务器，有公网 IP。
  2. 安装 Node 18+、pnpm，把项目 clone 上去，`pnpm build && pnpm start`，或用项目里的 **Dockerfile** 跑 Docker。
  3. 用 Nginx（或 Caddy）反代并配 HTTPS，DNS 把 **report.amzaiagent.com** 指到该服务器。
- 报告在服务器磁盘上，记得定期备份 **content/reports**。

---

## 三、环境变量（上线必配）

在 Vercel 或服务器上设置（生产环境务必用强 token、不要用示例值）：

```bash
# 鉴权（必填，生产未配置会 500）
API_ACCESS_TOKEN=你的强随机 token
NEXT_PUBLIC_API_ACCESS_TOKEN=同上

# 前端用的访问地址（用于 OpenRouter 等）
NEXT_PUBLIC_APP_URL=https://report.amzaiagent.com

# 可选：支持/联系
NEXT_PUBLIC_SUPPORT_EMAIL=你的邮箱

# LLM（报告生成 + 智能问答）
OPENROUTER_API_KEY=你的 key
LLM_BASE_URL=https://openrouter.ai/api/v1
LLM_MODEL=anthropic/claude-sonnet-4.5
# 可选，建议填
OPENROUTER_HTTP_REFERER=https://report.amzaiagent.com

# 报告生成用到的数据源（按需）
# RAPIDAPI_KEY=...
# SCRAPINGBEE_API_KEY=...
```

若开启了「访问码」，还需在服务器/Vercel 里加一条：

```bash
ACCESS_CODE=你设定的访问码字符串
```

（只发给付费用户，不要写进公开文档。）

---

## 四、访问码（仅付费用户可进，可选）

- 在环境变量里设置 **ACCESS_CODE**（例如一个随机字符串），只有输入正确访问码的用户能进入系统。
- 设置后：
  - 首次打开 `https://report.amzaiagent.com` 会先到「请输入访问码」页；
  - 输入正确后写入 Cookie，之后同浏览器无需再输；
  - 把 **访问码** 和 **链接** 一起只发给已付费用户即可。
- 不设置 ACCESS_CODE 时，不做访问码校验，仅靠「不公开链接」控制也可以。

---

## 五、上线后建议

1. **备份**：若用方式 B，定期把服务器上的 **content/reports** 目录打包备份到 U 盘或网盘。
2. **HTTPS**：务必用 HTTPS，避免 token 和对话内容走明文。
3. **付费用户**：只把 `https://report.amzaiagent.com`（以及访问码，若启用）通过私信/邮件发给付费用户，主站不挂入口。

这样系统在子域名上稳定运行，只有你知道链接（和访问码）的人能用，适合「只给已付费用户使用」的场景。
