# 新报告生成流程梳理

> 仅作流程与需求梳理，不涉及实现细节。

---

## 一、用户输入（前端表单）

| 输入项 | 说明 |
|--------|------|
| **主品 ASIN（Core Product）** | 用户自己的产品，可多个 ASIN；报告以「主品」为核心做分析。 |
| **站点（Marketplace）** | 下拉选择。每个站点的主品需单独列出（因同一 ASIN 在不同站点可能不同）。 |
| **竞品 ASIN** | 用于对比、参考的竞品，可多个。 |
| **报告参考语言（Report Language）** | 不是「报告输出语言」。报告**核心是中文**，另选一种**参考语言**（如美国站选英文）。即：中文为主、该语言为辅；关键场景、关键词等该出现英文/该语言的地方必须出现。 |
| **模型选择** | 用户选择大模型，通过 **OpenRouter** 调用。 |
| **参考网站数量** | 如 10 / 20 / 30，表示要抓取多少个「与产品相关」的网页作为参考资料。 |
| **参考 YouTube 视频数量** | 如 10 / 20 / 30，表示要抓取多少个相关视频的**字幕**作为参考资料。 |
| **退货报告文件** | 用户上传。支持 CSV / TXT / Excel，内容抽出为文本作参考资料。 |
| **人群画像文件** | 用户上传。支持 CSV / TXT / Excel，内容抽出为文本作参考资料。 |
| **核心提示词** | 用户填写/上传。框定报告的**框架与结构**，交给大模型，让输出按此框架生成。 |

---

## 二、数据获取（按输入去拉取/解析）

### 2.1 产品信息（RapidAPI）

- **触发**：用户提交的主品 ASIN + 竞品 ASIN（含站点）。
- **动作**：对**每一个 ASIN** 调用 RapidAPI，抓取产品信息（标题、价格等完整字段）。
- **结果**：每个 ASIN 一份产品数据，全部作为后续分析与大模型输入。

### 2.2 产品评论（RapidAPI）

- **触发**：同上，针对这些 ASIN。
- **动作**：通过 RapidAPI 抓取评论。
  - 若某 ASIN 评论数 > 100：抓取 100 条。
  - 若 ≤ 100：有多少抓多少。
- **结果**：所有评论作为大模型的分析参考。

### 2.3 参考网站（数量由用户选：10/20/30）

- **步骤 1**：根据产品信息（主品等）分析「产品是什么」，得到关键产品关键词。
- **步骤 2**：用这些关键词搜索，找到与产品**相关**的网站链接。  
  「相关」指：产品生产/制造、产品对比、使用分享、评测等类型。
- **步骤 3**：按用户选择的数量（如 10 个）取足链接。
- **步骤 4**：用 **ScrapingBee API** 抓取每个链接的网页内容。
- **步骤 5**：从页面中**只提取正文/核心内容**，去掉边栏、广告等边角料。
- **结果**：N 篇「网站核心正文」文本，作为参考资料。

### 2.4 参考 YouTube 视频（数量由用户选：10/20/30）

- **步骤 1**：根据产品与关键词，找到与产品相关的视频链接。  
  相关类型：生产、对比、分析、分享、演示等。
- **步骤 2**：按用户选择的数量（如 10/20/30）取足链接。
- **步骤 3**：用 **ScrapingBee API** 抓取这些视频的**字幕**。
- **结果**：N 份字幕文本，作为参考资料。

### 2.5 用户上传文件（本地解析，不调外部 API）

- **退货报告**：CSV / TXT / Excel → 解析为纯文本。
- **人群画像**：CSV / TXT / Excel → 解析为纯文本。
- **结果**：两份文本块，作为参考资料。

---

## 三、交给大模型的内容（组装）

将以下内容**一起**交给 OpenRouter 大模型：

1. **核心提示词**（用户输入）—— 定义报告框架与结构。  
2. **主品 + 竞品** 的 RapidAPI 产品信息（每个 ASIN 一份）。  
3. **主品 + 竞品** 的评论（每 ASIN 最多 100 条，或全部）。  
4. **报告参考语言** 与「中文为主、参考语言为辅」的写作要求。  
5. **参考网站** 的正文内容（10/20/30 篇）。  
6. **参考 YouTube** 的字幕内容（10/20/30 份）。  
7. **退货报告** 解析出的文本。  
8. **人群画像** 解析出的文本。  

大模型在**同一轮（或你设计的上下文）**内基于以上全部内容，按「核心提示词」的框架生成报告。

---

## 四、输出与回传

- 大模型生成的**报告正文**（按框架、中英混合等要求）。
- 系统将报告回传到后端，并展示在**系统页面上**（报告详情页等）。

---

## 五、流程简图（概念）

```
用户输入
  ├ 主品 ASIN（多）+ 站点
  ├ 竞品 ASIN（多）
  ├ 报告参考语言、模型、核心提示词
  ├ 参考网站数、参考视频数
  └ 上传：退货报告、人群画像

        ↓

数据获取（可并行或分步）
  ├ RapidAPI → 每个 ASIN 的产品信息
  ├ RapidAPI → 每个 ASIN 的评论（≤100 条/ASIN）
  ├ 关键词 → 找相关网站链接 → ScrapingBee 抓正文（N 个）
  ├ 关键词 → 找相关 YouTube → ScrapingBee 抓字幕（N 个）
  └ 解析上传文件 → 退货报告文本、人群画像文本

        ↓

组装成「上下文」+ 核心提示词 → OpenRouter 大模型

        ↓

报告正文 → 回传系统 → 展示在页面
```

---

## 六、报告提示词与核心逻辑（与 n8n 对齐）

以下提炼自你已确定好的 **System Prompt** 和 **User Prompt**，变量写法按 n8n，实现时用我们自己的字段替换即可。核心逻辑一致。

### 6.1 交给大模型的「输入数据」结构（6 块）

| 数据块 | 含义 | 无数据时的占位 |
|--------|------|----------------|
| **主产品 ASIN** | 主品 ASIN（可多个），报告以此为核心 | 必填 |
| **竞品 ASIN 列表** | 竞品 ASIN 列表，作为对比对象 | 必填 |
| **Products Info（混合）** | 主品 + 所有竞品的产品信息（标题、规格、描述等）合并成一段混合文本 | 必填（有 ASIN 就有） |
| **Products Reviews（混合）** | 主品 + 所有竞品的评论合并成一段混合文本 | 必填 |
| **Reference Sites（通用）** | 参考网站正文合并文本，按产品类别/关键词抓的，不按 ASIN 区分 | 可为空字符串 |
| **Reference YouTube（通用）** | 参考 YouTube 字幕合并文本，通用类别，不按 ASIN 区分 | 可为空字符串 |
| **Retours（退货报告）** | 用户上传的退货报告解析出的纯文本 | 无则传 **`NO_RETURN_REPORT`** |
| **Persona（人群画像）** | 用户上传的人群报告解析出的纯文本 | 无则传 **`NO_PERSONA_REPORT`** |

另外传入：**报告语言**（如「英文」）、**报告框架**（即用户填的 **custom_prompt / 核心提示词**）。

### 6.2 核心逻辑（大模型要做什么）

1. **主/竞品分离**  
   从**混合**的 Products Info 和 Products Reviews 中，推断并区分：哪些属于主品、哪些属于哪个竞品 ASIN。报告里必须**明确标注**信息来源（主品 / 竞品 ASIN）。

2. **报告框架**  
   严格按用户提供的 **custom_prompt（核心提示词）** 作为报告框架与结构，不得擅自改结构。

3. **语言**  
   报告语言 = **中文 + 用户选的报告语言**（如英文）。该用中文用中文，该用外语（英/德/日/法/意等）用外语，关键场景、关键词、品类术语等按场景选择语言。

4. **占位符处理**  
   若退货报告内容为 `NO_RETURN_REPORT`，或人群报告为 `NO_PERSONA_REPORT`：视为该数据源不存在，**忽略对应分析**，不报错、不追问，其余部分正常写。

5. **质量与格式**  
   - 总字数不少于 **6000 汉字**（或要求的其他语言等价）。  
   - 深入、详细、论点有数据支撑（引用评论关键词、网站要点等）。  
   - 排版美观、结构清晰、**合理使用表格**，输出完整连贯的竞品分析报告。

### 6.3 System Prompt 角色与风格（摘要）

- 角色：顶级市场分析专家，擅长亚马逊等电商平台竞品分析。  
- 任务：基于多维度信息（产品信息、评论、参考网站、YouTube 等）为主产品撰写**全面、深入、结构清晰、数据驱动**的报告。  
- 要求：严格遵循用户给的报告框架；语言专业流畅；该用表格用表格，该用外语用外语、该用中文用中文；最终输出为**完整、连贯、排版美观、结构清晰**的文档。

### 6.4 实现时我们要做的事（对齐 n8n 逻辑）

- 后端组装 **6 块数据**：main_asins、competitor_asins、products_info 混合文本、combined_reviews 混合文本、combined_web_content、combined_transcript、退货报告文本或 `NO_RETURN_REPORT`、人群报告文本或 `NO_PERSONA_REPORT`。  
- 用你确定好的 **System Prompt** 和 **User Prompt** 模板，把上述字段代入（替换 n8n 变量），调用 OpenRouter。  
- 保证：产品信息与评论是**按 ASIN 抓取后再合并成混合文本**，而不是让大模型去调 API；参考网站/YouTube 是**通用类别内容**，不要求按 ASIN 拆分。

---

## 七、与当前实现的差异（便于后续对齐）

- **当前**：已有主品/竞品 ASIN、站点、参考网页 URL、模型、上传文件、核心提示词等；RapidAPI 产品信息、ScrapingBee 网页抓取已接入；报告语言、评论数、网站/视频数量与来源、字幕抓取等可能不全或未按上述逻辑实现。
- **目标**：按本文「一～六」的输入、数据源、组装方式及**提示词核心逻辑**做齐；报告语言为「中文 + 报告语言」、占位符 `NO_RETURN_REPORT` / `NO_PERSONA_REPORT`、混合数据分离与标注、≥6000 字及表格等均与 n8n 逻辑一致。

梳理完。需要落地时再按此文档拆接口与前端/后端任务，并用你确定好的 System/User Prompt 模板调用 OpenRouter。
