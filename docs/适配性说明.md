# 适配性说明（多环境 / 协作者拉取后必读）

本文档说明在「从 GitHub 拉取到另一台机器 / 另一人」时，**为什么可能「打不开」**，以及**只该改哪些配置、不该改哪些代码**，避免误改导致功能丢失。

---

## 一、为什么拉取后可能「打不开」？

常见原因（均为**环境/配置**问题，不需要改业务代码）：

| 原因 | 说明 | 正确做法 |
|------|------|----------|
| **运行目录错误** | 仓库根目录没有 `package.json`，可运行的应用在子目录 `report-generation-system` 内 | 始终在 **report-generation-system** 下执行 `pnpm install` 和 `pnpm dev` |
| **没有环境变量** | `.env*` 已被 Git 忽略，拉取后没有 `.env.local`；缺 `OPENROUTER_API_KEY` 时报告生成会报错，页面可能异常 | 复制 `.env.example` 为 `.env.local`，至少填 `OPENROUTER_API_KEY`（见 README） |
| **未安装依赖** | 拉取后未执行 `pnpm install` | 在 `report-generation-system` 下执行 `pnpm install` |
| **Node / pnpm 版本** | 项目使用 Next 16、pnpm；若本机只有 npm 或 Node 过旧，可能报错 | 建议 Node 18+，使用 pnpm（或按 package.json 用 npm 装依赖后 `npm run dev`） |
| **端口被占用** | 默认 3000 被占用时 `pnpm dev` 可能失败 | 使用 `pnpm exec next dev -H 127.0.0.1 -p 3001` 并访问 3001 端口 |

**结论**：按「启动说明」在正确目录下配好 `.env.local` 并安装依赖即可打开，**不要通过改源码来“修”打不开的问题**。

---

## 二、容易被误改、导致功能出问题的地方（请勿改）

以下逻辑已在当前版本定好，改错会导致「你之前的一些功能」消失或错乱：

1. **仪表盘「我的报告」/「精选报告」**
   - **我的报告**：`source === "system"` 且未归档的报告（本系统生成的报告）。
   - **精选报告**：`source === "uploaded"` 且未归档的报告（上传/导入的报告）。
   - 对应代码：`app/dashboard/page.tsx` 中 `featuredReports`、`myReports`、`filteredReports`、`displayedFeaturedReports`、`sortedMyReports`。
   - 若被改成不按 `source` 或 `archivedStatus` 过滤/排序，会出现「我的报告」和「精选报告」混在一起或为空。

2. **报告来源（source）**
   - API 在 `app/api/reports/route.ts` 中根据 meta 的 `source` 返回：`uploaded`（精选）或 `system`（本系统生成）。
   - 若有人把 `source` 统一改成某一类或改字段名，仪表盘 Tab 的筛选会错乱。

3. **content/reports 目录**
   - 报告与元数据存放在 `content/reports/`（由 `lib/server/report-storage.ts` 的 `getReportsDir()` 使用 `process.cwd()` 解析）。
   - 不要改成绝对路径或其它目录，否则不同机器路径不一致，会读不到报告。

4. **API 鉴权**
   - 开发环境下未配置 `API_ACCESS_TOKEN` 时，接口会放行以便本地调试；生产环境必须配置。
   - 逻辑在 `lib/server/api-guard.ts`。若被改成「始终校验」且未配 token，前端会 401，页面看起来像「打不开」。

5. **dev 启动命令**
   - `package.json` 中：`"dev": "next dev -H 127.0.0.1 -p 3000"`。
   - 仅当本机 3000 被占用时，可在本地用 `-p 3001` 等方式改端口，**不要**把这段从 package.json 里删掉或改成别的框架命令，否则协作者拉取后脚本不一致。

---

## 三、允许的、仅限本机的调整

- **端口**：本机 3000 被占用时，在终端用 `pnpm exec next dev -H 127.0.0.1 -p 3001` 启动，无需改 package.json。
- **环境变量**：在 `.env.local` 里改 API Key、Referer、APP_URL 等（不要提交 `.env.local`）。
- **Node/pnpm 版本**：本机安装 Node 18+ 和 pnpm，保证能跑即可。

---

## 四、协作者（如 Antigravity）拉取后推荐步骤

1. 进入 **report-generation-system** 目录。
2. `cp .env.example .env.local`，编辑 `.env.local` 至少填 `OPENROUTER_API_KEY`。
3. `pnpm install` → `pnpm dev`。
4. 若仍打不开，只改端口或本机环境，**不要改** dashboard 的筛选逻辑、report 的 source、api-guard、report-storage 路径等，否则会破坏已有功能。

若你这边已经因误改出现「我的报告 / 精选报告不对」或功能缺失，请用 Git 对齐到远程 `dev` 分支的最近一次提交（例如 `git fetch origin && git checkout dev && git reset --hard origin/dev`），再按上述步骤重新配置 `.env.local` 和依赖。
