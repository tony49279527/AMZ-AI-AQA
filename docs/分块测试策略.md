# 分块测试策略

> 先对每个模块做**独立、小范围**测试，确认都成功后再做**全流程**报告测试，避免反复跑整条链路消耗付费 API（RapidAPI、ScrapingBee、OpenRouter）额度或触发限流。

---

## 一、原则

- **分块测**：每个数据/能力单独可测（例如「只测 RapidAPI 拉 1 个 ASIN 产品信息」「只测 ScrapingBee 抓 1 个网页」），不依赖整份报告生成。
- **小量测**：用 1～2 个 ASIN、1 个 URL、1 个小文件等，尽量少用 API 配额。
- **全流程最后测**：各块都通过后，再跑 1～2 次完整报告，用于验收。

---

## 二、可独立测试的模块清单

| 模块 | 测什么 | 建议测试方式 | 消耗 |
|------|--------|--------------|------|
| **A. 产品信息（RapidAPI）** | 提交 1～2 个 ASIN + 站点，能拿到产品详情（标题、价格等） | 独立脚本或测试接口，只调 `fetchAmazonDataFromRapidAPI`，打印/返回结果 | 1～2 次 RapidAPI 调用 |
| **B. 产品评论（RapidAPI）** | 提交 1 个 ASIN + 站点，能拿到评论（至少第 1 页） | 独立脚本或测试接口，只调 `fetchProductReviewsFromRapidAPI`，打印/返回条数+前几条 | 1～2 次 product-reviews 调用 |
| **C. 参考网页（ScrapingBee）** | 提交 1 个 URL，能拿到网页正文（去 HTML 后的文本） | 独立脚本或测试接口，只调 `fetchWebWithScrapingBee`，返回前 500 字或 char_count | 1 次 ScrapingBee 调用 |
| **D. 上传文件解析** | 上传 1 个小 CSV 或 TXT，能解析出纯文本 | 独立脚本或测试接口：读本地小文件或 multipart 上传，只做解析，返回解析后文本长度/前 200 字 | 不消耗外部 API |
| **E. 提示词模板填充** | 用假数据（短文本）替换 10 个占位符，拼出完整 User Prompt | 独立脚本：读模板 + 假 6 块数据，输出替换后的字符串（不调 OpenRouter） | 不消耗 |
| **F. 单次 OpenRouter 小测** | 用极短上下文（如 100 字产品信息 + 50 字评论）调一次 OpenRouter，能返回一段话 | 独立脚本或测试接口：只发 1 次 chat/completions，max_tokens=200，验证 Key 与模型可用 | 极少 token |
| **G. YouTube 链接 + 字幕**（阶段二） | 给定产品关键词或 1 个视频 URL，能拿到链接/字幕 | 等你提供接口后，再做独立脚本或测试接口 | 依你接口而定 |

---

## 三、实现方式建议

### 3.1 方式一：独立脚本（推荐先做）

在 `scripts/` 下为每个模块写一个**可单独运行**的脚本，你用少量真实参数（如 1 个 ASIN、1 个 URL）跑一次，看输出是否合理。

| 脚本 | 作用 | 用法示例 |
|------|------|----------|
| `scripts/test-rapidapi-product.mjs` | 只拉产品信息 | `node scripts/test-rapidapi-product.mjs B0XXX US` |
| `scripts/test-rapidapi-reviews.mjs` | 只拉评论 | `node scripts/test-rapidapi-reviews.mjs B0XXX US` |
| `scripts/test-scrapingbee.mjs` | 只抓一个网页 | `node scripts/test-scrapingbee.mjs "https://..."` |
| `scripts/test-parse-file.mjs` | 只解析一个本地 CSV/TXT | `node scripts/test-parse-file.mjs ./sample.csv` |
| `scripts/test-prompt-fill.mjs` | 只做占位符替换，不调 LLM | `node scripts/test-prompt-fill.mjs`（内部用假数据） |
| `scripts/test-openrouter-mini.mjs` | 用极短内容调一次 OpenRouter | `node scripts/test-openrouter-mini.mjs` |

脚本内通过 `dotenv` 或 `process.env` 读 `.env.local` 的 Key，不写死密钥。

### 3.2 方式二：测试用 API 路由（可选）

若你更习惯用 Postman/curl 测，可以加**仅开发/测试用**的接口（例如只在 `NODE_ENV=development` 时挂载）：

| 路由 | 作用 |
|------|------|
| `POST /api/test/fetch-product` | body: `{ asin, marketplace }`，只调 RapidAPI 产品，返回产品文本或 JSON |
| `POST /api/test/fetch-reviews` | body: `{ asin, marketplace }`，只调 RapidAPI 评论，返回评论条数+摘要 |
| `POST /api/test/fetch-web` | body: `{ url }`，只调 ScrapingBee，返回文本长度+前 N 字 |
| `POST /api/test/parse-file` | multipart 一个文件，只解析，返回解析结果长度/前 N 字 |

这样你可以不启动前端，直接对后端「单点」发请求验证。

---

## 四、建议测试顺序（分块 → 再全流程）

```
1. 测 A：产品信息（1 个 ASIN）→ 通过再继续
2. 测 B：评论（1 个 ASIN，1 页）→ 通过再继续
3. 测 C：ScrapingBee 抓 1 个 URL → 通过再继续
4. 测 D：解析本地 1 个 CSV/TXT → 通过再继续
5. 测 E：模板替换（假数据，不调 API）→ 通过再继续
6. 测 F：OpenRouter 极短调用一次 → 通过再继续
7. 全流程：1 次完整报告（主品+竞品各 1 个 ASIN、1 个 webUrl、可选 1 个小文件）
```

每个分块通过后，再接入到「报告生成」主流程；全流程只在你确认各块都 OK 后跑 1～2 次。

---

## 五、与实施阶段的衔接

- **开发顺序**：每做一个「块」（例如 RapidAPI 产品），就**先写该块的独立测试脚本**，你跑通后，再把这部分接到 generate 流程里。
- **集成顺序**：  
  - 1a 里用到的块：A、C、D、E、F → 建议先有 A/C/D/E/F 的脚本，你测过再合到 1a。  
  - 1b 用到的块：B（评论）→ 先有 B 的脚本，测过再接 1b。  
- 这样**不会**出现「一上来就全流程、某一环报错导致整次请求浪费」的情况；你可以在不烧钱的前提下把每一环都验证到。

---

## 六、小结

| 你的诉求 | 做法 |
|----------|------|
| 分块测试，不一次赌全流程 | 每个模块有独立脚本或测试接口，用 1 个 ASIN/1 个 URL/1 个小文件测 |
| 少用付费 API | 分块测时只调 1～2 次对应 API；全流程只在各块通过后跑 1～2 次 |
| 不信一次性写对 | 先实现并测通 A→B→C→D→E→F，再接到 generate；任一块失败只影响该块，不拖垮整次报告 |

实施时建议：**先给你写好 A/B/C 的测试脚本**（产品、评论、网页），你本地跑通并确认结果符合预期后，再把这些能力接到「阶段 1a/1b」的完整流程里；最后再一起跑 1～2 次完整报告测试。
