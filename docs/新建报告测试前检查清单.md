# 新建报告测试前检查清单

在开始测试「新建报告」前，请按下面逐项确认，避免卡在 500 或「无数据」上。

---

## 一、必填（缺一不可）

| 项目 | 说明 | 如何确认 |
|------|------|----------|
| **OPENROUTER_API_KEY** | 报告生成与智能问答用的 LLM，未配置会直接返回 500「未配置 API Key」 | 在 `.env.local` 中填写，重启 `pnpm dev` 后生效 |
| **运行目录** | 必须在 `report-generation-system` 下执行 `pnpm dev` | 终端当前路径包含 `report-generation-system` |
| **依赖已安装** | 否则 Node 会报错 | 在 `report-generation-system` 下执行过 `pnpm install` |
| **必填表单** | 标题、主品 ASIN、竞品 ASIN、站点 | 新建报告页：标题、主品 ASIN、竞品 ASIN、站点 不能为空 |

---

## 二、可选但影响「有真实数据」的报告

| 项目 | 作用 | 不填时的表现 |
|------|------|--------------|
| **SCRAPINGBEE_API_KEY** | 参考网站搜索 + 网页抓取 + YouTube 搜索与字幕（一个 key 全搞定） | 报告仍会生成，但「参考网站」「YouTube 字幕」为空（占位符） |
| **RAPIDAPI_KEY** | 拉取亚马逊产品信息与评论 | 产品信息、评论为占位符「暂无产品数据」「暂无评论数据」；且**搜索关键词来自产品标题**，无产品数据时不会去搜参考网站和 YouTube |
| **SERPER_API_KEY** | 仅当不用 ScrapingBee 时，用作 Google 搜索找参考链接（抓取网页仍要 ScrapingBee） | 有 SCRAPINGBEE 时不需要；无 SCRAPINGBEE 时仅 Serper 无法抓取网页正文 |

结论：若希望报告里既有产品/评论，又有参考网站和 YouTube 字幕，需要同时配置 **OPENROUTER_API_KEY**、**SCRAPINGBEE_API_KEY**、**RAPIDAPI_KEY**。

---

## 三、生产环境额外项

| 项目 | 说明 |
|------|------|
| **API_ACCESS_TOKEN** | 生产环境必填，否则接口返回 500「Server misconfigured」 |
| **NEXT_PUBLIC_API_ACCESS_TOKEN** | 前端请求需带与上面一致的 token（通过 x-api-token 头），否则 401 |

开发环境（`NODE_ENV !== 'production'`）下未配置 `API_ACCESS_TOKEN` 时，不会校验 token，可直接调接口。

---

## 四、快速自检步骤

1. **确认 .env.local 存在且至少包含：**
   ```bash
   OPENROUTER_API_KEY=sk-or-...   # 必填
   ```
2. **（可选）若需完整数据，再补：**
   ```
   SCRAPINGBEE_API_KEY=...
   RAPIDAPI_KEY=...
   ```
3. 在 `report-generation-system` 下执行 `pnpm dev`，浏览器打开终端里显示的 Local 地址（如 http://127.0.0.1:3000）。
4. 进入「新建报告」，填写标题、主品 ASIN（至少一个 10 位合法 ASIN）、竞品 ASIN、选择站点，点击生成。
5. 若返回 500，看接口返回里的 `code`：`LLM_API_KEY_MISSING` 表示未配置 `OPENROUTER_API_KEY`；其他错误可复制错误信息排查。

---

## 五、报告生成流程与依赖小结

```
用户提交 → enforceApiGuard（开发环境可不配 token）
         → 解析表单（title, coreAsins, competitorAsins, marketplace, ...）
         → 校验 OPENROUTER_API_KEY（无则 500）
         → 拉取产品信息（有 RAPIDAPI_KEY 才有真实数据）
         → 拉取评论（同上）
         → 按产品关键词搜参考网站并抓取（需 SCRAPINGBEE 或 SERPER；抓取正文需 SCRAPINGBEE）
         → 按产品关键词搜 YouTube 并抓字幕（需 SCRAPINGBEE）
         → 调用 LLM 生成报告 → 写入 content/reports/
```

目录 `content/reports` 会在首次生成时自动创建，无需手动建。
